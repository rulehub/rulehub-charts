name: Update CI Image Tag

on:
    workflow_dispatch:
        inputs:
            tag:
                description: "Immutable ci image tag to set (e.g., 2025.10.13-deadbeef or vX.Y.Z)"
                required: false
    repository_dispatch:
        types: [ci-image-published]

permissions:
    contents: read
    actions: write

jobs:
    resolve-ci-image:
        name: Resolve CI image
        uses: rulehub/rulehub/.github/workflows/resolve-ci-image.yml@main
        with:
            kind: base

    set-var:
        needs: [resolve-ci-image]
        runs-on: ubuntu-latest
        container:
            image: "${{ needs.resolve-ci-image.outputs.image }}"
            options: --user 0:0
        steps:
            - name: Checkout
              uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
            - name: Resolve tag
              id: params
              shell: bash
              env:
                  TAG_INPUT: ${{ inputs.tag }}
                  GITHUB_EVENT_JSON: ${{ toJson(github.event) }}
              run: |
                  set -euo pipefail
                  tag="$(bash hack/ci/resolve-ci-tag.sh || true)"
                  echo "tag=${tag}" >> "$GITHUB_OUTPUT"
            - name: Skipped (no tag provided)
              if: ${{ steps.params.outputs.tag == '' }}
              run: echo "No tag provided; skipping variable update (ACT/local runs may omit tag)." >> "$GITHUB_STEP_SUMMARY"
            - name: Update repository variable CI_IMAGE_TAG
              if: ${{ steps.params.outputs.tag != '' }}
              uses: actions/github-script@v8
              env:
                  TAG: ${{ steps.params.outputs.tag }}
              with:
                  script: |
                      const tag = process.env.TAG;
                      core.info(`Setting CI_IMAGE_TAG=${tag}`);
                      await github.rest.actions.createOrUpdateRepoVariable({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        name: 'CI_IMAGE_TAG',
                        value: tag,
                      });
            - name: Summary
              if: ${{ steps.params.outputs.tag != '' }}
              run: echo "CI_IMAGE_TAG set to '${{ steps.params.outputs.tag }}'" >> "$GITHUB_STEP_SUMMARY"
